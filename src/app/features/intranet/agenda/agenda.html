<div class="agenda-container">

  <div class="content-wrapper">

    <!-- Calendar Grid -->
    <div class="calendar-wrapper">
      <!-- Header -->
      <div class="agenda-header">
        <div class="header-left">
          <button mat-icon-button class="nav-button" (click)="decrementView()">
            <mat-icon>chevron_left</mat-icon>
          </button>

          <div class="datepicker-trigger-container">
            <button mat-icon-button class="nav-button" (click)="picker.open()">
              <mat-icon>calendar_today</mat-icon>
            </button>

            <input
              matInput
              [matDatepicker]="picker"
              [(ngModel)]="viewDate"
              (dateChange)="onDatePicked($event.value)"
              class="hidden-input"
              #dateInput>

            <mat-datepicker #picker [touchUi]="false"></mat-datepicker>
          </div>

          <button mat-icon-button class="nav-button" (click)="incrementView()">
            <mat-icon>chevron_right</mat-icon>
          </button>

          <button mat-stroked-button class="today-button" (click)="goToToday()">
            Hoy
          </button>

          <div class="date-range">
            <span class="range-text">{{ getRangeLabel() }}</span>
          </div>
        </div>

        <div class="header-right">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Estado</mat-label>
            <mat-select [(ngModel)]="selectedStatus" (selectionChange)="onStatusFilterChange()">
              <mat-option *ngFor="let status of statusOptions" [value]="status.value">
                {{ status.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <button mat-flat-button class="view-mode-button" [matMenuTriggerFor]="viewMenu">

            <span class="view-label-text">{{ getViewLabel() }}</span>

            <mat-icon class="view-icon-end">arrow_drop_down</mat-icon>
          </button>

          <mat-menu #viewMenu="matMenu" class="custom-view-menu">
            <button mat-menu-item (click)="changeView(CalendarView.Day)">
              <mat-icon>view_day</mat-icon>
              <span>DÃ­a</span>
            </button>
            <button mat-menu-item (click)="changeView(CalendarView.Week)">
              <mat-icon>view_week</mat-icon>
              <span>Semana</span>
            </button>
            <button mat-menu-item (click)="changeView(CalendarView.Month)">
              <mat-icon>calendar_month</mat-icon>
              <span>Mes</span>
            </button>
          </mat-menu>

          <button mat-icon-button class="settings-button">
            <mat-icon>settings</mat-icon>
          </button>
          <button mat-icon-button class="settings-button">
            <mat-icon>more_vert</mat-icon>
          </button>

          <button mat-icon-button (click)="isSidebarVisible = !isSidebarVisible" class="settings-button">
            <mat-icon>{{ isSidebarVisible ? 'last_page' : 'first_page' }}</mat-icon>
          </button>

        </div>
      </div>
      <ng-template #eventTemplate let-weekEvent="weekEvent" let-locale="locale">
        <div class="custom-event-card"
             [style.border-left-color]="getStatusColor(weekEvent.event.meta.appointment.estado)"
             (click)="handleEventClick(weekEvent.event)">
          <div class="event-title">
            <strong>{{ weekEvent.event.title }}</strong>
          </div>
          <div class="event-subtitle">
            {{ weekEvent.event.meta.appointment.motivo }}
          </div>
        </div>
      </ng-template>

      <div [ngSwitch]="view">
        <mwl-calendar-month-view
          *ngSwitchCase="CalendarView.Month"
          [viewDate]="viewDate"
          [events]="events"
          [locale]="'es'"
          [refresh]="refresh"
          (eventClicked)="handleEventClick($event.event)">
        </mwl-calendar-month-view>

        <mwl-calendar-week-view
          *ngSwitchCase="CalendarView.Week"
          [viewDate]="viewDate"
          [events]="events"
          [locale]="'es'"
          [refresh]="refresh"
          [dayStartHour]="8"
          [dayEndHour]="20"
          [eventTemplate]="eventTemplate"
          (eventClicked)="handleEventClick($event.event)">
        </mwl-calendar-week-view>

        <mwl-calendar-day-view
          *ngSwitchCase="CalendarView.Day"
          [viewDate]="viewDate"
          [events]="events"
          [locale]="'es'"
          [refresh]="refresh"
          [hourSegments]="2"
          [dayStartHour]="8"
          [dayEndHour]="20"
          (eventClicked)="handleEventClick($event.event)">
        </mwl-calendar-day-view>
      </div>
    </div>


    <div class="doctors-sidebar" [class.collapsed]="!isSidebarVisible">
      <div class="sidebar-header" *ngIf="isSidebarVisible">
        <mat-icon class="sidebar-icon">filter_list</mat-icon>
        <span>Todas las agendas</span>
      </div>

      <div class="doctors-list" *ngIf="isSidebarVisible">
        <div
          *ngFor="let doctor of doctors"
          class="doctor-item"
          [class.active]="selectedDoctors.includes(doctor.id)"
          (click)="toggleDoctorFilter(doctor.id)"
        >
          <div class="doctor-avatar" [style.background-color]="doctor.color">
            <mat-icon>person</mat-icon>
          </div>
          <div class="doctor-info">
            <span class="doctor-name">{{ doctor.nombre }} {{ doctor.apellido }}</span>
          </div>
          <button mat-icon-button class="doctor-menu-button" (click)="$event.stopPropagation()">
            <mat-icon>more_vert</mat-icon>
          </button>
        </div>

        <button mat-button class="add-doctor-button">
          <mat-icon>add</mat-icon>
          Agregar
        </button>
      </div>
    </div>
  </div>
</div>
